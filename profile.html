<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>NyashGram ‚Äî –ü—Ä–æ—Ñ–∏–ª—å</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .profile-container {
      max-width: 400px;
      margin: 40px auto;
      padding: 20px;
      text-align: center;
    }
    .avatar-preview {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: #ff9acb;
      margin: 20px auto;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      color: white;
      background-size: cover;
      background-position: center;
    }
    input, button {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    button {
      background: var(--accent);
      color: white;
      border: none;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="profile-container">
    <h1>–°–æ–∑–¥–∞–π —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h1>

    <input type="text" id="displayName" placeholder="–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?" required />

    <div class="avatar-upload">
      <label for="avatarInput">
        <div id="avatarPreview" class="avatar-preview">+</div>
        <p>–í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</p>
      </label>
      <input type="file" id="avatarInput" accept="image/*" style="display:none;" />
    </div>

    <button id="saveProfileBtn">–ì–æ—Ç–æ–≤–æ!</button>
  </div>

  <script type="module">
    import { auth, db, storage } from './firebase.js';

    // –ñ–¥—ë–º, –ø–æ–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑—É–µ—Ç—Å—è
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        // –ï—Å–ª–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω ‚Äî –Ω–∞–∑–∞–¥ –Ω–∞ –ª–æ–≥–∏–Ω
        window.location.href = "login.html";
        return;
      }

      // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –ø—Ä–æ—Ñ–∏–ª—å
      const userDoc = await db.collection("users").doc(user.uid).get();

      if (userDoc.exists) {
        // –ü—Ä–æ—Ñ–∏–ª—å —É–∂–µ –µ—Å—Ç—å ‚Üí —Å—Ä–∞–∑—É –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω
        alert("–ü—Ä–æ—Ñ–∏–ª—å —É–∂–µ —Å–æ–∑–¥–∞–Ω! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –æ–±—Ä–∞—Ç–Ω–æ~");
        window.location.href = "index.html";
        return;
      }

      // –ü—Ä–æ—Ñ–∏–ª—è –Ω–µ—Ç ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
      document.querySelector(".profile-container").style.display = "block";

      // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∞–≤–∞—Ç–∞—Ä–∫–∏
      document.getElementById("avatarInput").addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            const preview = document.getElementById("avatarPreview");
            preview.style.backgroundImage = `url(${event.target.result})`;
            preview.textContent = "";
          };
          reader.readAsDataURL(file);
        }
      });

      // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
      document.getElementById("saveProfileBtn").addEventListener("click", async () => {
        const name = document.getElementById("displayName").value.trim();
        if (!name) return alert("–í–≤–µ–¥–∏ –∏–º—è!");

        const file = document.getElementById("avatarInput").files[0];
        let avatarUrl = "";

        if (file) {
          try {
            const ref = storage.ref(`avatars/${user.uid}`);
            await ref.put(file);
            avatarUrl = await ref.getDownloadURL();
          } catch (err) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∫–∏:", err);
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ. –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –±–µ–∑ –Ω–µ–≥–æ.");
          }
        }

        try {
          await db.collection("users").doc(user.uid).set({
            phone: user.phoneNumber,
            name,
            avatar: avatarUrl || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=ff9acb&color=fff`,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });

          alert("–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ NyashGram ü©∑");
          window.location.href = "index.html"; // –∏–ª–∏ "contacts.html"
        } catch (err) {
          alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " + err.message);
          console.error(err);
        }
      });
    });
  </script>
</body>
</html>